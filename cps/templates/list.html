<!-- Calibre-Web Automated – fork of Calibre-Web
Copyright (C) 2018-2025 Calibre-Web contributors
Copyright (C) 2024-2025 Calibre-Web Automated contributors
SPDX-License-Identifier: GPL-3.0-or-later
See CONTRIBUTORS for full list of authors. -->

{% extends "layout.html" %}
{% block body %}
<h1 class="{{page}}">{{_(title)}}</h1>

    <div class="filterheader hidden-xs">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% if entries.__len__() and data == 'author' %}
        <div id="sort_name" class="btn btn-primary"><b>B,A <-> A B</b></div>
      {% endif %}
      <div id="asc" data-order="{{ order }}" data-id="{{ data }}" class="btn btn-primary {% if order == 1 %} active{% endif%}"><span class="glyphicon glyphicon-sort-by-alphabet"></span></div>
      <div id="desc" data-id="{{ data }}" class="btn btn-primary{% if order == 0 %} active{% endif%}"><span class="glyphicon glyphicon-sort-by-alphabet-alt"></span></div>
      {% if charlist|length %}
      <div id="all" class="active btn btn-primary">{{_('All')}}</div>
      {% endif %}
      {% if charlist|length %}
        {% if charlist|length > 9 %}
          <!-- Use a dropdown when there are many characters -->
          <div class="character-dropdown" style="display:inline-block; margin-left: .5rem;">
            <label for="char-dropdown" class="sr-only">{{ _('Filter by initial') }}</label>
            <select id="char-dropdown" class="form-control" style="display:inline-block; width:auto;">
              <option value="" selected disabled>{{ _('Filter by initial') }}</option>
              {% for char in charlist %}
                <option value="{{char[0]}}">{{char[0]}}</option>
              {% endfor %}
            </select>
          </div>
        {% else %}
          <div class="btn-group character" role="group">
            {% for char in charlist%}
            <div class="btn btn-primary char">{{char[0]}}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}

      {% if data == "series" %}
      <button class="update-view btn btn-primary" data-target="series_view" id="grid-button" data-view="grid">{{_('Grid')}}</button>
      {% endif %}

      <!-- Bouton Add to Shelf générique pour toutes les entités -->
      {% if data in ["series", "author", "category", "publisher"] %}
      <div id="add_entity_to_shelf_btn" class="btn btn-primary" data-entity-type="{{ data }}">
        <span class="glyphicon glyphicon-list"></span> {{_('Add to Shelf')}}
      </div>
      {% endif %}
    </div>
  <div class="container" id="{{_(title)}}">
    {% if title == "Downloads" %}
      <h1 style="padding-top: 1rem; padding-bottom: 2rem;">Users Downloaded Books:</h1>
    {% endif %}
    <div id="{{_(title)}}_list" class="col-xs-12 col-sm-6 list-container">
    {% for entry in entries %}
      {% if loop.index0 == (loop.length/2+loop.length%2)|int and loop.length > 20 %}
        </div>
        <div id="second" class="col-xs-12 col-sm-6">
      {% endif %}
      <div class="row" id="{{_(title)}}_row" {% if entry[0].sort %}data-name="{{entry[0].name}}"{% endif %} data-id="{% if entry[0].sort %}{{entry[0].sort}}{% else %}{% if entry[0].format %}{{entry[0].format}}{% else %}{% if entry[0].rating %}{{entry[0].rating}}{% else %}{{entry[0].name}}{% endif %}{% endif %}{% endif %}">
        <div class="col-xs-2 col-sm-2 col-md-1" align="left"><span class="badge">{{entry[1]}}</span></div>
        <div class="col-xs-10 col-sm-10 col-md-11">
          <a style="width: -webkit-fill-available; display: block;" id="list_{{loop.index0}}" href="{% if entry.format %}{{url_for('web.books_list', data=data, sort_param='stored', book_id=entry.format )}}{% else %}{{url_for('web.books_list', data=data, sort_param='stored', book_id=entry[0].id )}}{% endif %}">
          {% if entry.name %}
          <div class="rating">
          {% for number in range(entry.name|int) %}
            <span class="glyphicon glyphicon-star good"></span>
            {% if loop.last and loop.index < 5 %}
              {% for numer in range(5 - loop.index) %}
                <span class="glyphicon glyphicon-star-empty"></span>
              {% endfor %}
            {% endif %}
          {% endfor %}
          </div>
          {% else %}
          {% if entry.format %}
            {{entry.format}}
          {% else %}
            {% if page == "authorlist" %}{{ entry[0].name.replace('|', ', ') }}{% else %}{{entry[0].name}}{% endif %}
          {% endif %}{% endif %}</a>
        </div>
      </div>
    {% endfor %}
    </div>
  </div>

<!-- Modal pour Add to Shelf générique -->
<div class="modal fade" id="addEntityToShelfModal" tabindex="-1" role="dialog" aria-labelledby="addEntityToShelfModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="addEntityToShelfModalLabel">{{_('Add Entity to Shelf')}}</h4>
      </div>
      <div class="modal-body">
        <p id="entitySelectLabel">{{_('Select an entity to add to shelf')}}:</p>
        <select id="entitySelect" name="entity" class="form-control">
          {% for entry in entries %}
            {% if entry[0].id and entry[0].name %}
              <option value="{{ entry[0].id }}" data-name="{{ entry[0].name }}">{{ entry[0].name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <br>

        <div class="radio">
          <label>
            <input type="radio" name="shelfOption" value="existing" checked>
            {{_('Use existing shelf')}}
          </label>
        </div>

        <select id="shelfSelect" name="shelf" class="form-control">
          {% for shelf in user_shelves %}
            <option value="{{ shelf.id }}">{{ shelf.name }}</option>
          {% endfor %}
          {% if not user_shelves %}
            <option value="" disabled>{{_('No shelves found')}}</option>
          {% endif %}
        </select>

        <div class="radio" style="margin-top: 15px;">
          <label>
            <input type="radio" name="shelfOption" value="create">
            {{_('Create new shelf with entity name')}}
          </label>
        </div>

        <div id="newShelfInfo" class="alert alert-info" style="margin-top: 10px; display: none;">
          <strong>{{_('New shelf will be created')}}:</strong> <span id="newShelfName"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelAddEntityToShelfBtn" type="button" class="btn btn-default" data-dismiss="modal">{{_('Cancel')}}</button>
        <input id="confirmAddEntityToShelfBtn" type="button" class="btn btn-primary" value="{{_('Add')}}">
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename='js/filter_list.js') }}"></script>
<script>
$(document).ready(function() {
    // Variables globales
    var currentEntityType = null;

    // Bouton principal Add to Shelf en haut de page
    $('#add_entity_to_shelf_btn').on('click', function(e) {
        currentEntityType = $(this).data('entity-type');

        // Vérifier s'il y a des entités sur la page
        if ($('#entitySelect option').length === 0) {
            alert('{{_("No entities found on this page")}}');
            return;
        }

        // Mettre à jour le titre du modal selon le type d'entité
        updateModalTitle(currentEntityType);

        // Configurer le nom de la shelle pour l'option création
        var firstEntityName = $('#entitySelect option:first').data('name') || $('#entitySelect option:first').text();
        $('#newShelfName').text(firstEntityName);

        // Afficher le modal
        $('#addEntityToShelfModal').modal('show');
    });

    // Mettre à jour le titre du modal selon le type d'entité
    function updateModalTitle(entityType) {
        var titles = {
            'series': "{{_('Add Series to Shelf')}}",
            'author': "{{_('Add Author to Shelf')}}",
            'category': "{{_('Add Category to Shelf')}}",
            'publisher': "{{_('Add Publisher to Shelf')}}"
        };
        var labels = {
            'series': "{{_('Select a series to add to shelf')}}:",
            'author': "{{_('Select an author to add to shelf')}}:",
            'category': "{{_('Select a category to add to shelf')}}:",
            'publisher': "{{_('Select a publisher to add to shelf')}}:"
        };

        $('#addEntityToShelfModalLabel').text(titles[entityType] || "{{_('Add Entity to Shelf')}}");
        $('#entitySelectLabel').text(labels[entityType] || "{{_('Select an entity to add to shelf')}}:");
    }

    // Mettre à jour le nom de la shelle quand l'entité change
    $('#entitySelect').on('change', function() {
        var entityName = $(this).find(':selected').data('name') || $(this).find(':selected').text();
        $('#newShelfName').text(entityName);
    });

    // Gestion des options de shelve
    $('input[name="shelfOption"]').on('change', function() {
        var option = $(this).val();
        if (option === 'create') {
            $('#shelfSelect').prop('disabled', true);
            $('#newShelfInfo').show();
        } else {
            $('#shelfSelect').prop('disabled', false);
            $('#newShelfInfo').hide();
        }
    });

    // Bouton Confirm du modal
    $('#confirmAddEntityToShelfBtn').on('click', function() {
        var entityId = $('#entitySelect').val();
        var entityName = $('#entitySelect option:selected').data('name') || $('#entitySelect option:selected').text();
        var shelfOption = $('input[name="shelfOption"]:checked').val();

        if (!entityId) {
            alert('{{_("Please select an entity")}}');
            return;
        }

        if (!currentEntityType) {
            alert('{{_("Entity type not specified")}}');
            return;
        }

        var ajaxUrl;
        var confirmMessage;

        if (shelfOption === 'create') {
            // Créer une nouvelle shelle
            ajaxUrl = '/shelf/create_and_add_entity/' + currentEntityType + '/' + entityId;
            confirmMessage = "Create a new shelf named '" + entityName + "' and add all books from this " + currentEntityType + " to it?";
        } else {
            // Utiliser une shelle existante
            var shelfId = $('#shelfSelect').val();
            if (!shelfId) {
                alert('{{_("Please select a shelf")}}');
                return;
            }
            ajaxUrl = '/shelf/add_entity/' + currentEntityType + '/' + entityId + '/' + shelfId;
            confirmMessage = "Add all books from " + currentEntityType + " '" + entityName + "' to this shelf?";
        }

        // Confirmation
        if (!confirm(confirmMessage)) {
            return;
        }

        // Désactiver le bouton pendant la requête
        $('#confirmAddEntityToShelfBtn').prop('disabled', true).val('{{_("Adding...")}}');

        // Envoyer la requête AJAX
        console.log('Adding entity', currentEntityType, entityId, 'with option:', shelfOption);
        console.log('AJAX URL:', ajaxUrl);

        $.ajax({
            url: ajaxUrl,
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#addEntityToShelfModal').modal('hide');

                if (response.status === 'success') {
                    // Message de succès
                    var flashHtml = '<div class="alert alert-success alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                        response.message +
                        '</div>';
                    $('body').prepend(flashHtml);
                } else if (response.status === 'info') {
                    // Message d'info
                    var flashHtml = '<div class="alert alert-info alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                        response.message +
                        '</div>';
                    $('body').prepend(flashHtml);
                } else {
                    // Message d'erreur
                    var flashHtml = '<div class="alert alert-danger alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                        response.message +
                        '</div>';
                    $('body').prepend(flashHtml);
                }
            },
            error: function(xhr, status, error) {
                $('#addEntityToShelfModal').modal('hide');
                console.error('AJAX Error:', xhr.status, status, error);
                console.error('Response Text:', xhr.responseText);

                // Message d'erreur détaillé
                var flashHtml = '<div class="alert alert-danger alert-dismissible">' +
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                    '<strong>Error ' + xhr.status + ':</strong> ' + error + '<br>' +
                    '<small>' + xhr.responseText + '</small>' +
                    '</div>';
                $('body').prepend(flashHtml);
            },
            complete: function() {
                // Réactiver le bouton
                $('#confirmAddEntityToShelfBtn').prop('disabled', false).val('{{_("Add")}}');
            }
        });
    });

    // Bouton Cancel du modal
    $('#cancelAddEntityToShelfBtn').on('click', function() {
        $('#addEntityToShelfModal').modal('hide');
    });
});
</script>
{% endblock %}
